events { }

http {
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # Important si certains clients envoient des en-t√™tes avec underscore
    underscores_in_headers on;

    upstream auth_service { server auth-service:8000; }
    upstream user_service { server user-service:8000; }
    upstream post_service { server post-service:8000; }
    upstream appointment_service { server appointment-service:8000; }
    upstream admin_service { server admin-service:8000; }
    upstream media_service { server media-service:8000; }

    server {
        listen 80;

        # En-t√™tes communs vers l'upstream
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # üîê Autorisation explicite (certains setups la perdent)
        proxy_set_header Authorization $http_authorization;

        # WebSocket/upgrade
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Confort
        proxy_buffering off;
        client_max_body_size 20m;

        # Health simple
        location = /health {
            return 200 'ok';
            add_header Content-Type text/plain;
        }

        location /auth/          { 
            proxy_pass http://auth_service;
        }
        location /users/         { 
            proxy_pass http://user_service/;
            proxy_set_header X-Original-URI $request_uri;
        }
        location /posts/         { proxy_pass http://post_service/; }
        location /appointments/  { proxy_pass http://appointment_service/; }
        location /admin/         { proxy_pass http://admin_service/; }
        
        location /media/ {
    client_max_body_size 200M;
    proxy_pass http://media_service;   # <- NO trailing slash
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

    }
}
